// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // Direct connection for server hosting (not serverless)
  // DATABASE_URL is configured in prisma.config.ts
  // Connection pooling is handled by the application
}

// enums
enum UserRole {
  ADMIN
  STAFF
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum PermissionKey {
  PROJECT_CREATE
  PROJECT_UPDATE
  PROJECT_DELETE
  PROJECT_VIEW
  PROJECT_ARCHIVE
  PROJECT_UNARCHIVE
  TASK_CREATE
  TASK_UPDATE
  TASK_DELETE
  TASK_ASSIGN
  TASK_VIEW
  STAFF_MANAGEMENT
  LIST_CREATE
  LIST_DELETE
  LIST_UPDATE
  WEBSITE_MANAGEMENT
  STAFF_PAGE_MANAGEMENT
}

enum EventColor {
  SKY
  AMBER
  VIOLET
  ROSE
  EMERALD
  ORANGE
}

enum Gender {
  MALE
  FEMALE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model User {
  id          String    @id @default(cuid())
  name        String
  email       String    @unique
  password    String
  phone       String?
  roleName    String?
  role        UserRole  @default(STAFF)
  dateOfBirth DateTime?
  gender      Gender    @default(MALE)
  nationality String?
  address     String?
  city        String?
  country     String?
  image       String?

  isActive Boolean @default(true)

  permissions     UserPermission[]
  createdEvents   Event[]          @relation("EventCreator")
  attendingEvents EventAttendee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  banners       Banner[]
  tasks         Task[]        @relation("createdTasks")
  assignedTasks Task[]        @relation("assignedTasks")
  taskComments  TaskComment[]
  subTasks      SubTasks[]
}

model Permission {
  id   String        @id @default(cuid())
  key  PermissionKey @unique
  name String

  users UserPermission[]
}

model UserPermission {
  id           String @id @default(cuid())
  userId       String
  permissionId String

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
}

model ProjectCategory {
  id        String   @id @default(cuid())
  nameAr    String
  nameEn    String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]
}

model Region {
  id     String @id @default(cuid())
  nameAr String
  nameEn String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cities City[]
}

model City {
  id     String @id @default(cuid())
  nameAr String
  nameEn String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  regionId String
  region   Region @relation(fields: [regionId], references: [id], onDelete: Cascade)

  projects Project[]
}

model TaskStatus {
  id        String   @id @default(cuid())
  nameAr    String
  nameEn    String
  color     String
  isSystem  Boolean  @default(false) // Fixed statuses (Pending, In Progress, Canceled, Done) - editable labels, cannot delete
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasks         Task[]
  taskTemplates TaskTemplate[]
}

model TaskCategory {
  id            String         @id @default(cuid())
  nameAr        String
  nameEn        String
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  tasks         Task[]
  taskTemplates TaskTemplate[]
}

model Project {
  id                String  @id @default(cuid())
  nameAr            String
  nameEn            String
  image             String?
  descriptionAr     String?
  descriptionEn     String?
  area              Float?
  numberOfFloors    Int?
  deedNumber        String?
  workDuration      Int?
  googleMapsAddress String?

  status     ProjectStatus @default(PLANNING)
  isActive   Boolean       @default(true)
  archivedAt DateTime?

  cityId String
  city   City   @relation(fields: [cityId], references: [id], onDelete: Cascade)

  categories     ProjectCategory[]
  attachments    ProjectAttachment[]
  additionalData ProjectAdditionalData[]
  tasks          Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProjectAttachment {
  id             String  @id @default(cuid())
  fileUrl        String
  fileName       String?
  fileType       String?
  fileSize       Int? // in bytes
  additionalInfo Json? // for storing additional important information as JSON

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProjectAdditionalData {
  id          String    @id @default(cuid())
  name        String
  value       Json // can store string, number, or boolean
  type        String // can be "text", "number", "boolean", "date", "time", "singleChoice", "multipleChoice"
  options     Json? // for choice fields
  min         Float?
  max         Float?
  minDate     DateTime?
  maxDate     DateTime?
  minTime     DateTime?
  maxTime     DateTime?
  placeholder String?
  required    Boolean   @default(false)
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Event {
  id          String     @id @default(cuid())
  title       String
  description String?
  start       DateTime
  end         DateTime
  allDay      Boolean    @default(false)
  color       EventColor @default(SKY)
  location    String?

  // Recurrence fields
  isRecurring       Boolean   @default(false)
  recurrenceRule    Json? // Stores recurrence pattern: { frequency: "WEEKLY", interval: 1, daysOfWeek: [1,3,5], endDate?: Date }
  recurrenceEndDate DateTime? // When the recurrence should end (optional)

  createdById String
  createdBy   User   @relation("EventCreator", fields: [createdById], references: [id], onDelete: Cascade)

  attendees EventAttendee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventAttendee {
  id      String @id @default(cuid())
  eventId String
  userId  String

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([eventId, userId])
}

model Banner {
  id            String   @id @default(cuid())
  titleAr       String
  titleEn       String
  descriptionAr String?
  descriptionEn String?
  content       String?
  image         String
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
}

model Website {
  id        String   @id @default(cuid())
  nameAr    String
  nameEn    String
  url       String
  image     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// tasks
model Task {
  id                   String           @id @default(cuid())
  title                String
  description          String?
  statusId             String
  status               TaskStatus       @relation(fields: [statusId], references: [id], onDelete: Cascade)
  category             TaskCategory[]
  estimatedWorkingDays Int?
  startedAt            DateTime?
  priority             TaskPriority     @default(MEDIUM)
  assignedTo           User[]           @relation("assignedTasks")
  createdById          String
  createdBy            User             @relation("createdTasks", fields: [createdById], references: [id], onDelete: Cascade)
  taskAttachments      TaskAttachment[]
  comments             TaskComment[]
  doneAt               DateTime?
  finalFileId          String?          @unique
  finalFile            TaskAttachment?  @relation("finalFile", fields: [finalFileId], references: [id])
  projectId            String
  project              Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  order                Int              @default(0) // order within project for drag-and-drop
  subTasks             SubTasks[]
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
}

model TaskComment {
  id          String   @id @default(cuid())
  content     String
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TaskAttachment {
  id             String  @id @default(cuid())
  fileUrl        String
  fileName       String?
  fileType       String?
  fileSize       Int? // in bytes
  additionalInfo Json? // for storing additional important information as JSON
  taskId         String
  task           Task    @relation(fields: [taskId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Reverse relation: task that has this attachment as its final file
  taskAsFinalFile Task? @relation("finalFile")
}

model SubTasks {
  id          String    @id @default(cuid())
  title       String
  description String?
  taskId      String
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  done        Boolean   @default(false)
  doneAt      DateTime?
  createdById String
  createdBy   User      @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Reusable task definitions stored at system level; can be added to any project later
model TaskTemplate {
  id                   String                @id @default(cuid())
  title                String
  description          String?
  estimatedWorkingDays Int?
  priority             TaskPriority          @default(MEDIUM)
  defaultStatusId      String?
  defaultStatus        TaskStatus?           @relation(fields: [defaultStatusId], references: [id], onDelete: SetNull)
  categories           TaskCategory[]
  subItems             TaskTemplateSubItem[]
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
}

// Subtask definitions for a task template; created as SubTasks when template is added to a project
model TaskTemplateSubItem {
  id             String       @id @default(cuid())
  title          String
  description    String?
  order          Int          @default(0)
  taskTemplateId String
  taskTemplate   TaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

// Global/system files not related to a specific project or task
model SystemFile {
  id             String  @id @default(cuid())
  fileUrl        String
  fileName       String?
  fileType       String?
  fileSize       Int? // in bytes
  additionalInfo Json? // extra metadata if needed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
